<!DOCTYPE html>
<html lang="zh-Hans">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="FluentPy Note（2）"/><meta name="keywords" content="Blog" /><link rel="alternate" href="/atom.xml" title="XU.IO"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://yoursite.com/2018/11/02/python/fluentpy2/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" /><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

    <title>FluentPy Note（2） - XU.IO</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">XU.IO</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">XU.IO</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            关于
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">FluentPy Note（2）
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-11-02
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#可迭代对象、迭代器和生成器"><span class="toc-text">可迭代对象、迭代器和生成器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现标准的可迭代协议"><span class="toc-text">实现标准的可迭代协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#标准库中的生成器函数"><span class="toc-text">标准库中的生成器函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上下文管理器和-else-块"><span class="toc-text">上下文管理器和 else 块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多线程与协程"><span class="toc-text">多线程与协程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Coroutines"><span class="toc-text">Coroutines</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#asyncio-run-coro-debug-False"><span class="toc-text">asyncio.run(coro,*,debug=False)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-Object"><span class="toc-text">Task Object</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#class-asyncio-Task-coro-loop-None"><span class="toc-text">class asyncio.Task(coro,*,loop=None)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#asyncio-create-task-coro"><span class="toc-text">asyncio.create_task(coro)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Awaitables"><span class="toc-text">Awaitables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#coroutine-asyncio-sleep-delay-result-None-loop-None"><span class="toc-text">coroutine asyncio.sleep(delay, result=None, *, loop=None)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Running-Tasks-Concurrently"><span class="toc-text">Running Tasks Concurrently</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#awaitable-asyncio-gather-aws-loop-None-return-exceptions-False"><span class="toc-text">awaitable asyncio.gather(*aws, loop=None, return_exceptions=False)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#元编程"><span class="toc-text">元编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用特性验证属性"><span class="toc-text">使用特性验证属性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#特性会覆盖实例属性"><span class="toc-text">特性会覆盖实例属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定义特性工厂函数"><span class="toc-text">定义特性工厂函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#影响属性处理方式的特殊属性"><span class="toc-text">影响属性处理方式的特殊属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#特殊方法"><span class="toc-text">特殊方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#属性描述符"><span class="toc-text">属性描述符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#类元编程"><span class="toc-text">类元编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#类装饰器"><span class="toc-text">类装饰器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#元类"><span class="toc-text">元类</span></a></li></ol></li></ol>
    </div>
  </div><div class="post-content"><h3 id="可迭代对象、迭代器和生成器"><a href="#可迭代对象、迭代器和生成器" class="headerlink" title="可迭代对象、迭代器和生成器"></a>可迭代对象、迭代器和生成器</h3><p>迭代器模式：惰性获取数据项的方式。</p>
<a id="more"></a>
<p>所有生成器都是迭代器，因为生成器完全实现了迭代器接口。在 Python社区中，大多数时候都把迭代器和生成器视作同一概念。</p>
<p>生成器应用广泛，即使是内置的range()也返回类似生成器对象，如果一定要返回列表，必须明确指明（例如，list(range(100))）。</p>
<p>序列可以迭代的原因：iter函数。</p>
<p>内置的iter函数有以下作用。</p>
<ol>
<li>检查对象是否实现了<code>__iter__</code>方法，如果实现了即调用，获取一个迭代器。</li>
<li>如果没有实现<code>__iter__</code>方法，但实现了<code>__getitem__</code>方法。Python会创建一个迭代器，尝试按顺序（从索引0开始）获取元素。</li>
<li>失败，抛出TypeError异常。</li>
</ol>
<p>任何 Python 序列都可迭代的原因是，它们都实现了<code>__getitem__</code> 方法。其实，标准的序列也都实现了 <code>__iter__</code>方法，因此你也应该这么做。之所以对 <code>__getitem__</code> 方法做特殊处理，是为了向后兼容，而未来可能不会再这么做（不过，写作本书时还未弃用）。</p>
<p>检查对象 x 能否迭代，最准确的方法是：调用 iter(x) 函数，如果不可迭代，再处理 TypeError 异常。</p>
<h4 id="实现标准的可迭代协议"><a href="#实现标准的可迭代协议" class="headerlink" title="实现标准的可迭代协议"></a>实现标准的可迭代协议</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sentence</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, text)</span>:</span></span><br><span class="line">        self.text = text</span><br><span class="line">        self.words = RE_WORD.findall(text)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">'Sentence(%s)'</span> % reprlib.repr(self.text)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span> </span><br><span class="line">    	<span class="keyword">return</span> SentenceIterator(self.words) </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SentenceIterator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, words)</span>:</span></span><br><span class="line">        self.words = words </span><br><span class="line">        self.index = <span class="number">0</span> </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">        	word = self.words[self.index] </span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration() </span><br><span class="line">        self.index += <span class="number">1</span> </span><br><span class="line">        <span class="keyword">return</span> word</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span> </span><br><span class="line">        <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure>
<p>Python函数中有yield生成器函数，返回生成器。</p>
<p>生成器表达式可以理解为列表推导的惰性版本：不会迫切地构建列表，而是返回一个生成器，按需惰性生成元素。</p>
<h4 id="标准库中的生成器函数"><a href="#标准库中的生成器函数" class="headerlink" title="标准库中的生成器函数"></a>标准库中的生成器函数</h4><p>按用途可分为以下几类：</p>
<ul>
<li>过滤</li>
<li>映射</li>
<li>合并</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">vowel</span><span class="params">(c)</span>:</span></span><br><span class="line"><span class="meta">... </span><span class="keyword">return</span> c.lower() <span class="keyword">in</span> <span class="string">'aeiou'</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(filter(vowel, <span class="string">'Aardvark'</span>))</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> itertools</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.filterfalse(vowel, <span class="string">'Aardvark'</span>))</span><br><span class="line">[<span class="string">'r'</span>, <span class="string">'d'</span>, <span class="string">'v'</span>, <span class="string">'r'</span>, <span class="string">'k'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.dropwhile(vowel, <span class="string">'Aardvark'</span>))</span><br><span class="line">[<span class="string">'r'</span>, <span class="string">'d'</span>, <span class="string">'v'</span>, <span class="string">'a'</span>, <span class="string">'r'</span>, <span class="string">'k'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.takewhile(vowel, <span class="string">'Aardvark'</span>))</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'a'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.compress(<span class="string">'Aardvark'</span>, (<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)))</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'r'</span>, <span class="string">'d'</span>, <span class="string">'a'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.islice(<span class="string">'Aardvark'</span>, <span class="number">4</span>))</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'a'</span>, <span class="string">'r'</span>, <span class="string">'d'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.islice(<span class="string">'Aardvark'</span>, <span class="number">4</span>, <span class="number">7</span>))</span><br><span class="line">[<span class="string">'v'</span>, <span class="string">'a'</span>, <span class="string">'r'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(itertools.islice(<span class="string">'Aardvark'</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">2</span>))</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'d'</span>, <span class="string">'a'</span>]</span><br></pre></td></tr></table></figure>
<p> yield from 语句。这个语句的作用就是把不同的生成器结合在一起使用。</p>
<h3 id="上下文管理器和-else-块"><a href="#上下文管理器和-else-块" class="headerlink" title="上下文管理器和 else 块"></a>上下文管理器和 else 块</h3><p>with open 创建文件不创建路径。</p>
<p>仅当 try 块中没有异常抛出时才运行 else 块。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	dangerous_call()</span><br><span class="line"><span class="keyword">except</span> OSError:</span><br><span class="line">	log(<span class="string">'OSError...'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	after_call()</span><br></pre></td></tr></table></figure>
<p>with语句的目的是简化try/finally模式。</p>
<p>与函数和模块不同，with 块没有定义新的作用域。</p>
<h3 id="多线程与协程"><a href="#多线程与协程" class="headerlink" title="多线程与协程"></a>多线程与协程</h3><p>标准库中所有执行阻塞型 I/O 操作的函数，在等待操作系统返回结果时都会释放 GIL。这意味着在 Python 语言这个层次上可以使用多线程，而 I/O 密集型 Python 程序能从中受益：一个 Python 线程等待网络响应时，阻塞型 I/O 函数会释放 GIL，再运行一个线程。</p>
<blockquote>
<p> <strong>Concurrency</strong> is when two or more tasks can start, run, and complete in overlapping time periods. It doesn’t necessarily mean they’ll ever both be running at the same instant. For example, <em>multitasking</em>on a single-core machine.</p>
<p><strong>Parallelism</strong> is when tasks <em>literally</em> run at the same time, e.g., on a multicore processor.</p>
</blockquote>
<blockquote>
<p>异步库依赖于低层线程（直至内核级线程），但是这些库的用户无需创建线程，也无需知道用到了基础设施中的低层线程。在应用中，我们只需确保没有阻塞的代码，事件循环会在背后处理并发。异步系统能避免用户级线程的开销，这是它能比多线程系统管理更多并发连接的主要原因。</p>
</blockquote>
<p>并发：充分运用CPU资源，主要是针对线程。</p>
<h4 id="Coroutines"><a href="#Coroutines" class="headerlink" title="Coroutines"></a>Coroutines</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">say_after</span><span class="params">(delay, what)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(delay)</span><br><span class="line">    print(what)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">f"started at <span class="subst">&#123;time.strftime(<span class="string">'%X'</span>)&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> say_after(<span class="number">1</span>, <span class="string">'hello'</span>)</span><br><span class="line">    <span class="keyword">await</span> say_after(<span class="number">2</span>, <span class="string">'world'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f"finished at <span class="subst">&#123;time.strftime(<span class="string">'%X'</span>)&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<h5 id="asyncio-run-coro-debug-False"><a href="#asyncio-run-coro-debug-False" class="headerlink" title="asyncio.run(coro,*,debug=False)"></a>asyncio.run(coro,*,debug=False)</h5><p>当前线程存在一个事件循环时，该函数不能调用。</p>
<p>该函数调用时新建一个事件循环并在结束时关闭循环。它应该被用作异步程序的主入口并且理想情况下，应该只调用一次。</p>
<h4 id="Task-Object"><a href="#Task-Object" class="headerlink" title="Task Object"></a>Task Object</h4><h5 id="class-asyncio-Task-coro-loop-None"><a href="#class-asyncio-Task-coro-loop-None" class="headerlink" title="class asyncio.Task(coro,*,loop=None)"></a>class asyncio.Task(coro,*,loop=None)</h5><p>Task用于在事件循环中运行协程。当一个协程等待一个Future时，Task中断协程的执行并等待Future完成。当Future完成，协程恢复。</p>
<p>事件循环使用竞争调度：一个事件循环同一时间只运行一个任务。然而，当一任务等待Future的完成时，事件循环运行其他任务等。</p>
<h5 id="asyncio-create-task-coro"><a href="#asyncio-create-task-coro" class="headerlink" title="asyncio.create_task(coro)"></a>asyncio.create_task(coro)</h5><p>把协程包装成Task并调度其执行。Task在事件循环中执行，这个循环通过get_running_loop()获得，若当前线程没有事件循环，抛出RuntimeError。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">say_after</span><span class="params">(delay, what)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(delay)</span><br><span class="line">    print(what)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    task1 = asyncio.create_task(say_after(<span class="number">1</span>, <span class="string">'hello'</span>))</span><br><span class="line">    task2 = asyncio.create_task(say_after(<span class="number">2</span>, <span class="string">'world'</span>))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f"started at <span class="subst">&#123;time.strftime(<span class="string">'%X'</span>)&#125;</span>"</span>)</span><br><span class="line">	<span class="comment"># 并发执行</span></span><br><span class="line">    <span class="keyword">await</span> task1</span><br><span class="line">    <span class="keyword">await</span> task2</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f"finished at <span class="subst">&#123;time.strftime(<span class="string">'%X'</span>)&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<h4 id="Awaitables"><a href="#Awaitables" class="headerlink" title="Awaitables"></a>Awaitables</h4><blockquote>
<p>There are three main types of <em>awaitable</em> objects: <strong>coroutines</strong>, <strong>Tasks</strong>, and <strong>Futures</strong>.</p>
</blockquote>
<blockquote>
<p><em>Tasks</em> are used to schedule coroutines <em>concurrently</em>.</p>
</blockquote>
<blockquote>
<p>A Future is a special low-level awaitable object that represents an eventual result of an asynchronous operation.</p>
<p>Normally <strong>there is no need</strong> to create Future objects at the application level code.</p>
</blockquote>
<h4 id="coroutine-asyncio-sleep-delay-result-None-loop-None"><a href="#coroutine-asyncio-sleep-delay-result-None-loop-None" class="headerlink" title="coroutine asyncio.sleep(delay, result=None, *, loop=None)"></a>coroutine asyncio.sleep(delay, result=None, *, loop=None)</h4><blockquote>
<p><code>sleep()</code> always suspends the current task, allowing other tasks to run.</p>
</blockquote>
<h4 id="Running-Tasks-Concurrently"><a href="#Running-Tasks-Concurrently" class="headerlink" title="Running Tasks Concurrently"></a>Running Tasks Concurrently</h4><h5 id="awaitable-asyncio-gather-aws-loop-None-return-exceptions-False"><a href="#awaitable-asyncio-gather-aws-loop-None-return-exceptions-False" class="headerlink" title="awaitable asyncio.gather(*aws, loop=None, return_exceptions=False)"></a>awaitable asyncio.gather(*aws, loop=None, return_exceptions=False)</h5><p>并发执行aws序列中的awaitable对象。</p>
<p>如果aws中有协程，自动当作Task调度。</p>
<blockquote>
<p>If all awaitables are completed successfully, the result is an aggregate list of returned values. The order of result values corresponds to the order of awaitables in <em>aws</em>.</p>
</blockquote>
<blockquote>
<p>If return_exceptions is False (default), the first raised exception is immediately propagated to the task that awaits on gather(). Other awaitables in the aws sequence won’t be cancelled and will continue to run.</p>
<p>If return_exceptions is True, exceptions are treated the same as successful results, and aggregated in the result list.</p>
<p>If gather() is cancelled, all submitted awaitables (that have not completed yet) are also cancelled.</p>
<p>If any Task or Future from the aws sequence is cancelled, it is treated as if it raised CancelledError – the gather() call is not cancelled in this case. This is to prevent the cancellation of one submitted Task/Future to cause other Tasks/Futures to be cancelled.</p>
</blockquote>
<h3 id="元编程"><a href="#元编程" class="headerlink" title="元编程"></a>元编程</h3><p>使用点号访问属性时，Python解释器会调用特殊方法（<code>__getattr__</code>和<code>__setattr__</code>）计算属性。</p>
<p><strong>特性：在不改变类接口的前提下，使用存取方法（即读值方法和设值方法）修改数据属性。</strong></p>
<h4 id="使用特性验证属性"><a href="#使用特性验证属性" class="headerlink" title="使用特性验证属性"></a>使用特性验证属性</h4><p>@property</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LineItem</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, description, weight, price)</span>:</span></span><br><span class="line">        self.description = description</span><br><span class="line">        <span class="comment"># 这里已经使用特性的设值方法了</span></span><br><span class="line">        self.weight = weight</span><br><span class="line">        self.price = price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subtotal</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.weight * self.price</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weight</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 真正的值存储在私有属性 __weight 中</span></span><br><span class="line">        <span class="keyword">return</span> self.__weight</span><br><span class="line"></span><br><span class="line"><span class="meta">    @weight.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weight</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span>:</span><br><span class="line">            self.__weight = value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'value must be &gt; 0'</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>被装饰的读值方法有个 .setter 属性，这个属性也是装饰器；这个装饰器把读值方法和设值方法绑定在一起。</p>
</blockquote>
<p>虽然property经常被当作装饰器使用，但它其实是一个类。构造方法如下：</p>
<p><code>property(fget=None, fset=None, fdel=None, doc=None)</code></p>
<p>老版Python这样用：weight = property(get_weight, set_weight)</p>
<h5 id="特性会覆盖实例属性"><a href="#特性会覆盖实例属性" class="headerlink" title="特性会覆盖实例属性"></a>特性会覆盖实例属性</h5><p>特性都是类属性，但特性管理的其实是实例属性的存取。</p>
<p>实例属性遮盖类的数据属性，但实例属性不会遮盖类特性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span>:</span> </span><br><span class="line">    data = <span class="string">'the class data attr'</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prop</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">'the prop value'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Class.prop <span class="comment"># 获取特性对象本身，不会运行特性读值方法</span></span><br><span class="line">&lt;property object at <span class="number">0x1072b7408</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj.prop <span class="comment"># 执行特性的读值方法</span></span><br><span class="line"><span class="string">'the prop value'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj.prop = <span class="string">'foo'</span> </span><br><span class="line"><span class="comment"># 尝试给obj设置prop实例属性，失败（这实现了只读）</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">AttributeError: can<span class="string">'t set attribute</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">&gt;&gt;&gt; obj.__dict__['</span>prop<span class="string">'] = '</span>foo<span class="string">'</span></span><br><span class="line"><span class="string"># 但是可以直接把 '</span>prop<span class="string">' 存入 obj.__dict__</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; vars(obj) # </span></span><br><span class="line"><span class="string">&#123; '</span>data<span class="string">': '</span>ba<span class="string">r','</span>prop<span class="string">': '</span>foo<span class="string">'&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt;&gt; obj.prop </span></span><br><span class="line"><span class="string"># 然而，读取 obj.prop 时仍会运行特性的读值方法。特性没被实例属</span></span><br><span class="line"><span class="string"># 性遮盖。 </span></span><br><span class="line"><span class="string">'</span>the prop value<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt;&gt; Class.prop = '</span>baz<span class="string">' </span></span><br><span class="line"><span class="string"># 覆盖 Class.prop 特性，销毁特性对象。 </span></span><br><span class="line"><span class="string">&gt;&gt;&gt; obj.prop </span></span><br><span class="line"><span class="string"># 现在，obj.prop 获取的是实例属性。 </span></span><br><span class="line"><span class="string">'</span>foo<span class="string">'</span></span><br></pre></td></tr></table></figure>
<h4 id="定义特性工厂函数"><a href="#定义特性工厂函数" class="headerlink" title="定义特性工厂函数"></a>定义特性工厂函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quantity</span><span class="params">(storage_name)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">qty_getter</span><span class="params">(instance)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> instance.__dict__[storage_name]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">qty_setter</span><span class="params">(instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span>:</span><br><span class="line">      		<span class="comment"># storage_name确定特性数据存储在哪儿</span></span><br><span class="line">            instance.__dict__[storage_name] = value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'value must be &gt; 0'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property(qty_getter, qty_setter)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListItem</span>:</span></span><br><span class="line">    <span class="comment"># 使用工厂函数将自定义特性weight定义为类属性</span></span><br><span class="line">    weight = quantity(<span class="string">'weight'</span>)</span><br><span class="line">    price = quantity(<span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, description, weight, price)</span>:</span></span><br><span class="line">        self.description = description</span><br><span class="line">        <span class="comment"># 这里使用特性设值方法</span></span><br><span class="line">        self.weight = weight</span><br><span class="line">        self.price = price</span><br></pre></td></tr></table></figure>
<h4 id="影响属性处理方式的特殊属性"><a href="#影响属性处理方式的特殊属性" class="headerlink" title="影响属性处理方式的特殊属性"></a>影响属性处理方式的特殊属性</h4><ul>
<li><code>__class__</code>对象所属类的引用，Python的<code>__getattr__</code>只在类中寻找，而不在实例中寻找。<code>__getattr__</code>只处理不存在的属性名。</li>
<li><code>__dict__</code>存储对象或类的可写属性。</li>
</ul>
<h4 id="特殊方法"><a href="#特殊方法" class="headerlink" title="特殊方法"></a>特殊方法</h4><ul>
<li><code>__delattr__(self, name)</code> 只要使用 del 语句删除属性，就会调用这个方法。</li>
<li><code>__getattr__(self, name)</code>仅当获取指定的属性失败，搜索过 obj、Class 和超类之后调用。表达式 obj.no_such_attr、getattr(obj, ‘no_such_attr’) 和hasattr(obj, ‘no_such_attr’) 可能会触发<code>Class.__getattr__(obj, &#39;no_such_attr&#39;)</code>方法，但是，仅当在<br>obj、Class 和超类中找不到指定的属性时才会触发。</li>
<li><code>__getattribute__(self, name)</code> 点号与 getattr 和 hasattr 内置函数会触发这个方法。尝试获取指定的属性时总会调用这个方法，不过，寻找的属性是特殊属性或特殊方法时除外。调用 <code>__getattribute__</code> 方法且抛出 AttributeError异常时，才会调用 <code>__getattr__</code>方法。</li>
<li><code>__setattr__(self, name, value)</code> 点号和 setattr 内置函数会触发这个方法。</li>
</ul>
<h3 id="属性描述符"><a href="#属性描述符" class="headerlink" title="属性描述符"></a>属性描述符</h3><p>描述符是对<strong>多个</strong>属性运行相同存取逻辑的一种方法。</p>
<p>描述符是实现了特定协议的类，这个协议包括<code>__get__</code>、<code>__set__</code>和<code>__delete__</code>。其实，我们在真实的代码中见到的大多数描述符只实现了 <code>__get__</code> 和<code>__set__</code> 方法，还有很多只实现了其中的一个。</p>
<p>property 类实现了完整的描述符协议。</p>
<p>特性工厂函数借助函数式编程模式避免重复编写读值方法和设值方法。解决这种问题的面向对象的方法是描述符类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Quantity</span>:</span> <span class="comment">#描述符类基于协议实现</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, storage_name)</span>:</span></span><br><span class="line">        self.storage_name = storage_name </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试为托管属性赋值（weight、price）赋值时，会调用__set__</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span> </span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span>:</span><br><span class="line">        	instance.__dict__[self.storage_name] = value </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">        	<span class="keyword">raise</span> ValueError(<span class="string">'value must be &gt; 0'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LineItem</span>:</span></span><br><span class="line">    weight = Quantity(<span class="string">'weight'</span>) </span><br><span class="line">    price = Quantity(<span class="string">'price'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, description, weight, price)</span>:</span> </span><br><span class="line">        self.description = description</span><br><span class="line">        self.weight = weight</span><br><span class="line">        self.price = price</span><br></pre></td></tr></table></figure>
<h3 id="类元编程"><a href="#类元编程" class="headerlink" title="类元编程"></a>类元编程</h3><p>类元编程是指在运行时创建或定制类的技术。</p>
<p>类装饰器也是函数，不过能够审查、修改，甚至把被装饰的类替换成其他类。</p>
<p>导入时和运行时区别——是有效使用Python元编程的重要基础。</p>
<h4 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoStorage</span>:</span></span><br><span class="line">    <span class="comment"># __counter = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""初始化工作在类修饰器中"""</span></span><br><span class="line">        <span class="comment"># cls = self.__class__</span></span><br><span class="line">        <span class="comment"># prefix = cls.__name__</span></span><br><span class="line">        <span class="comment"># index = cls.__counter</span></span><br><span class="line">        <span class="comment"># self.storage_name = f"_&#123;prefix&#125;#&#123;index&#125;"</span></span><br><span class="line">        <span class="comment"># cls.__counter += 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> getattr(instance, self.storage_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        setattr(instance, self.storage_name, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Validated</span><span class="params">(abc.ABC, AutoStorage)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        value = self.validate(instance, value)</span><br><span class="line">        super().__set__(instance, value)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="string">"""return vaildated value or ValueError"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Quantity</span><span class="params">(Validated)</span>:</span></span><br><span class="line">    <span class="string">"""a number greater than zero"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'value must be &gt; 0'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonBlank</span><span class="params">(Validated)</span>:</span></span><br><span class="line">    <span class="string">"""a string non-space"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        value = value.strip()</span><br><span class="line">        <span class="keyword">if</span> len(value) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'value cannot be empty or blank'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">entity</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> key, attr <span class="keyword">in</span> cls.__dict__.items():</span><br><span class="line">        <span class="keyword">if</span> isinstance(attr, Validated):</span><br><span class="line">            type_name = type(attr).__name__</span><br><span class="line">            attr.storage_name = <span class="string">f"_<span class="subst">&#123;type_name&#125;</span>#<span class="subst">&#123;key&#125;</span>"</span></span><br><span class="line">    <span class="keyword">return</span> cls</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> model_v5 <span class="keyword">as</span> model</span><br><span class="line"></span><br><span class="line"><span class="meta">@model.entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LineItem</span>:</span></span><br><span class="line">    description = model.NonBlank()</span><br><span class="line">    weight = model.Quantity()</span><br><span class="line">    price = model.Quantity()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, description, weight, price)</span>:</span></span><br><span class="line">        self.description = description</span><br><span class="line">        self.weight = weight</span><br><span class="line">        self.price = price</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    item1 = LineItem(<span class="string">"something"</span>, <span class="number">15</span>, <span class="number">12</span>)</span><br><span class="line">    print(dir(item1)[:<span class="number">3</span>])</span><br><span class="line">    print(LineItem.description.storage_name)</span><br><span class="line">    print(item1.description)</span><br><span class="line">    print(getattr(item1, <span class="string">'_NonBlank#description'</span>))</span><br></pre></td></tr></table></figure>
<p>类装饰器以较简单的方式做到以前元类去做的事情——创建类时定制类。</p>
<p>类装饰器有个重大缺点：只对直接依附的类有效。这意味着，被装饰的类的子类可能继承也可能不继承装饰器所做的改动，具体情况视改动的方式而定。</p>
<h4 id="元类"><a href="#元类" class="headerlink" title="元类"></a>元类</h4><p>用于构建类的类。Python中，类也是对象，因此类必然是某个类的实例。默认情况下，Python类是type类的实例。也就是说，type 是大多数内置的类和用户定义的类的元类。为了避免无限回溯，type 是其自身的实例。</p>

      </div>
      
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/python/">python</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2018/11/12/java/java8/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Java8 Learn</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2018/11/02/python/fluentpy/">
        <span class="next-text nav-default">FluentPy Note（1）</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:xu.io@qq.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/Langzi418" class="iconfont icon-github" title="github"></a>
        </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2018 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">XU.IO</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
